<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
import configparser
=======
# The following comment should be removed at some point in the future.
# mypy: disallow-untyped-defs=False

from __future__ import absolute_import

>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
from __future__ import annotations

import configparser
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
from __future__ import annotations

import configparser
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
import logging
import os
from typing import List, Optional, Tuple

from pip._internal.exceptions import BadCommand, InstallationError
from pip._internal.utils.misc import HiddenText, display_path
from pip._internal.utils.subprocess import make_command
from pip._internal.utils.urls import path_to_url
from pip._internal.vcs.versioncontrol import (
    RevOptions,
    VersionControl,
    find_path_to_project_root_from_repo_root,
    vcs,
)

logger = logging.getLogger(__name__)


class Mercurial(VersionControl):
    name = "hg"
    dirname = ".hg"
    repo_name = "clone"
    schemes = (
        "hg+file",
        "hg+http",
        "hg+https",
        "hg+ssh",
        "hg+static-http",
    )

    @staticmethod
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    def get_base_rev_args(rev: str) -> List[str]:
        return [f"--rev={rev}"]
=======
    def get_base_rev_args(rev):
        return [rev]
>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
    def get_base_rev_args(rev: str) -> list[str]:
        return [f"--rev={rev}"]
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
    def get_base_rev_args(rev: str) -> list[str]:
        return [f"--rev={rev}"]
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b

    def fetch_new(
        self, dest: str, url: HiddenText, rev_options: RevOptions, verbosity: int
    ) -> None:
        rev_display = rev_options.to_display()
        logger.info(
            "Cloning hg %s%s to %s",
            url,
            rev_display,
            display_path(dest),
        )
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
        if verbosity <= 0:
            flags: Tuple[str, ...] = ("--quiet",)
=======
        if verbosity <= 0:
            flags: tuple[str, ...] = ("--quiet",)
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
        if verbosity <= 0:
            flags: tuple[str, ...] = ("--quiet",)
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
        elif verbosity == 1:
            flags = ()
        elif verbosity == 2:
            flags = ("--verbose",)
        else:
            flags = ("--verbose", "--debug")
        self.run_command(make_command("clone", "--noupdate", *flags, url, dest))
<<<<<<< HEAD
<<<<<<< HEAD
=======
        self.run_command(make_command('clone', '--noupdate', '-q', url, dest))
>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
        self.run_command(
            make_command("update", *flags, rev_options.to_args()),
            cwd=dest,
        )

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    def switch(self, dest: str, url: HiddenText, rev_options: RevOptions) -> None:
        repo_config = os.path.join(dest, self.dirname, "hgrc")
=======
    def switch(self, dest, url, rev_options):
        # type: (str, HiddenText, RevOptions) -> None
        repo_config = os.path.join(dest, self.dirname, 'hgrc')
>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
=======
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
    def switch(
        self,
        dest: str,
        url: HiddenText,
        rev_options: RevOptions,
        verbosity: int = 0,
    ) -> None:
        extra_flags = []
        repo_config = os.path.join(dest, self.dirname, "hgrc")
<<<<<<< HEAD
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
        config = configparser.RawConfigParser()

        if verbosity <= 0:
            extra_flags.append("-q")

        try:
            config.read(repo_config)
            config.set("paths", "default", url.secret)
            with open(repo_config, "w") as config_file:
                config.write(config_file)
        except (OSError, configparser.NoSectionError) as exc:
            logger.warning("Could not switch Mercurial repository to %s: %s", url, exc)
        else:
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
            cmd_args = make_command("update", "-q", rev_options.to_args())
            self.run_command(cmd_args, cwd=dest)

    def update(self, dest: str, url: HiddenText, rev_options: RevOptions) -> None:
        self.run_command(["pull", "-q"], cwd=dest)
        cmd_args = make_command("update", "-q", rev_options.to_args())
=======
            cmd_args = make_command('update', '-q', rev_options.to_args())
            self.run_command(cmd_args, cwd=dest)

    def update(self, dest, url, rev_options):
        # type: (str, HiddenText, RevOptions) -> None
        self.run_command(['pull', '-q'], cwd=dest)
        cmd_args = make_command('update', '-q', rev_options.to_args())
>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
            cmd_args = make_command("update", *extra_flags, rev_options.to_args())
            self.run_command(cmd_args, cwd=dest)

=======
            cmd_args = make_command("update", *extra_flags, rev_options.to_args())
            self.run_command(cmd_args, cwd=dest)

>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
    def update(
        self,
        dest: str,
        url: HiddenText,
        rev_options: RevOptions,
        verbosity: int = 0,
    ) -> None:
        extra_flags = []

        if verbosity <= 0:
            extra_flags.append("-q")

        self.run_command(["pull", *extra_flags], cwd=dest)
        cmd_args = make_command("update", *extra_flags, rev_options.to_args())
<<<<<<< HEAD
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
        self.run_command(cmd_args, cwd=dest)

    @classmethod
    def get_remote_url(cls, location: str) -> str:
        url = cls.run_command(
            ["showconfig", "paths.default"],
            show_stdout=False,
            stdout_only=True,
            cwd=location,
        ).strip()
        if cls._is_local_repository(url):
            url = path_to_url(url)
        return url.strip()

    @classmethod
    def get_revision(cls, location: str) -> str:
        """
        Return the repository-local changeset revision number, as an integer.
        """
        current_revision = cls.run_command(
            ["parents", "--template={rev}"],
            show_stdout=False,
            stdout_only=True,
            cwd=location,
        ).strip()
        return current_revision

    @classmethod
    def get_requirement_revision(cls, location: str) -> str:
        """
        Return the changeset identification hash, as a 40-character
        hexadecimal string
        """
        current_rev_hash = cls.run_command(
            ["parents", "--template={node}"],
            show_stdout=False,
            stdout_only=True,
            cwd=location,
        ).strip()
        return current_rev_hash

    @classmethod
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    def is_commit_id_equal(cls, dest: str, name: Optional[str]) -> bool:
=======
    def is_commit_id_equal(cls, dest, name):
>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
    def is_commit_id_equal(cls, dest: str, name: str | None) -> bool:
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
    def is_commit_id_equal(cls, dest: str, name: str | None) -> bool:
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
        """Always assume the versions don't match"""
        return False

    @classmethod
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    def get_subdirectory(cls, location: str) -> Optional[str]:
=======
    def get_subdirectory(cls, location):
>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
    def get_subdirectory(cls, location: str) -> str | None:
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
    def get_subdirectory(cls, location: str) -> str | None:
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
        """
        Return the path to Python project root, relative to the repo root.
        Return None if the project root is in the repo root.
        """
        # find the repo root
        repo_root = cls.run_command(
            ["root"], show_stdout=False, stdout_only=True, cwd=location
        ).strip()
        if not os.path.isabs(repo_root):
            repo_root = os.path.abspath(os.path.join(location, repo_root))
        return find_path_to_project_root_from_repo_root(location, repo_root)

    @classmethod
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    def get_repository_root(cls, location: str) -> Optional[str]:
        loc = super().get_repository_root(location)
=======
    def get_repository_root(cls, location):
        loc = super(Mercurial, cls).get_repository_root(location)
>>>>>>> 667482d8b430caa0727488b1d1900471cb8d5208
=======
    def get_repository_root(cls, location: str) -> str | None:
        loc = super().get_repository_root(location)
>>>>>>> c67f90bd6d99f24b568e213ed27f14d7420ce66d
=======
    def get_repository_root(cls, location: str) -> str | None:
        loc = super().get_repository_root(location)
>>>>>>> c386aa5fe352f969882abba769ec53b58b48337b
        if loc:
            return loc
        try:
            r = cls.run_command(
                ["root"],
                cwd=location,
                show_stdout=False,
                stdout_only=True,
                on_returncode="raise",
                log_failed_cmd=False,
            )
        except BadCommand:
            logger.debug(
                "could not determine if %s is under hg control "
                "because hg is not available",
                location,
            )
            return None
        except InstallationError:
            return None
        return os.path.normpath(r.rstrip("\r\n"))


vcs.register(Mercurial)
